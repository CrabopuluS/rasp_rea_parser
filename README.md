# rasp_rea_parser

Парсер расписания РЭУ им. Г.В. Плеханова с CLI и Telegram-ботом. Скрипты загружают расписание с [rasp.rea.ru](https://rasp.rea.ru/), превращают занятия в удобные `.ics` файлы (мобильный календарь и Google Calendar) и показывают расписание недели текстом.

## Возможности
- Загрузка расписания по коду группы или прямому URL.
- Формирование двух `.ics`: локальный (MSK, цвет/напоминания) и совместимый с Google Calendar.
- Текстовое расписание текущей недели с указанием преподавателя и аудитории.
- Плановая отправка текста расписания по московскому времени.
- Работа через CLI и Telegram-бот (поллинг).

## Требования
- Python 3.12+
- Зависимости: `requests`, `beautifulsoup4`, `tzdata` (для Windows), `python-telegram-bot` (для бота), `pytest` (для тестов).

Установите их командой:
```bash
pip install -r requirements.txt
# или вручную:
pip install requests beautifulsoup4 tzdata python-telegram-bot pytest
```

## Конфигурация окружения
Бот и CLI читают переменные окружения. Чтобы не экспортировать их вручную, положите их в `.env` в корне проекта — скрипт автоматически загрузит значения при старте:
```env
TELEGRAM_BOT_TOKEN=<токен_бота>
SCHEDULE_URL=https://rasp.rea.ru/?q=15.14%D0%B4-%D0%B3%D0%B301%2F24%D0%BC
SCHEDULE_GROUP=15.14д-гг01/24м
```

Пример лежит в `.env.example` — скопируйте его в `.env` и подставьте свои значения.

Значения `SCHEDULE_URL` и `SCHEDULE_GROUP` опциональны; если их нет, будут использованы значения по умолчанию из кода.

## CLI
Сохранение расписания в `.ics`:
```bash
python schedule_parser.py \
  --url "https://rasp.rea.ru/?q=15.14%D0%B4-%D0%B3%D0%B301%2F24%D0%BC" \
  --group "15.14д-гг01/24м" \
  --output "schedule_15_14.ics" \
  --google-output "schedule_15_14_google.ics" \
  --verbose
```

Ключи `--url`, `--group`, `--output` и `--google-output` имеют значения по умолчанию и могут не указываться. Флаг `--verbose` включает отладочные сообщения.

## Telegram-бот
1. Убедитесь, что переменная `TELEGRAM_BOT_TOKEN` задана (экспортируйте или используйте `.env`).
2. Запустите бота:
```bash
python bot.py
```
3. Используйте команды:
   - `/week [url] [group]` — показывает расписание текущей недели текстом; если аргументы не указаны, используются значения по умолчанию.
   - `/ics [url] [group]` — отправляет два `.ics` файла (мобильный и Google) с теми же правилами аргументов.
   - `/plan <YYYY-MM-DD> <HH:MM> [url] [group]` — планирует отправку текста в московском времени; команда валидирует формат даты/времени и число аргументов.
   - В личных сообщениях можно написать любую фразу: бот вернёт расписание, а при упоминании `ics` — файлы.
   - В группах бот отвечает на сообщения с «распис» или на упоминание его имени; **в BotFather нужно отключить Privacy Mode**, иначе бот не увидит текстовые сообщения.

## Тесты
Запуск тестов (без сетевых запросов):
```bash
pytest
```

## Безопасность и стабильность
- Все функции имеют полную обработку ошибок и исключений.
- Добавлено логирование всех критических операций.
- Валидация входных данных (URL, коды групп, даты и времени).
- Защита от таймаутов при сетевых запросах.
- Правильное управление временными файлами (не открываются в удаленных директориях).

## Типичные проблемы
- **Бот молчит в группах.** Отключите Privacy Mode в BotFather, чтобы бот видел текстовые сообщения, и убедитесь в правильности `TELEGRAM_BOT_TOKEN` (лучше через `.env`).
- **Пустой ответ/файл.** Убедитесь в правильности `--url` и `--group`; сайт может менять структуру страниц — смотрите логи с `--verbose` или уровень `INFO` в боте.
- **Часовой пояс.** Установите `tzdata` на Windows, чтобы корректно обрабатывать время.
- **Ошибки при отправке .ics.** Проверьте сетевое соединение; бот читает файлы в память до удаления временной директории и отправляет их как документы через `BytesIO`.
